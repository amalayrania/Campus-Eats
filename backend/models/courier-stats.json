import express from 'express';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const router = express.Router();
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const courierStatsFilePath = path.join(__dirname, '../models/courier-stats.json');

// Helper function to read courier stats
async function readCourierStats() {
  try {
    const data = await fs.readFile(courierStatsFilePath, 'utf-8');
    return JSON.parse(data);
  } catch (error) {
    return [];
  }
}

// Helper function to write courier stats
async function writeCourierStats(stats) {
  await fs.writeFile(courierStatsFilePath, JSON.stringify(stats, null, 2));
}

// Get courier stats for a specific courier
router.get('/:courierId', async (req, res) => {
  try {
    const stats = await readCourierStats();
    const courierStat = stats.find(s => s.courierId === req.params.courierId);
    
    if (!courierStat) {
      // Return default stats if courier doesn't exist yet
      return res.json({
        courierId: req.params.courierId,
        deliveries: 0,
        earnings: 0,
        rating: 0,
        totalRatings: 0
      });
    }
    
    res.json(courierStat);
  } catch (error) {
    console.error('Error reading courier stats:', error);
    res.status(500).json({ error: 'Failed to fetch courier stats' });
  }
});

// Update courier stats (when they complete a delivery)
router.post('/:courierId/delivery', async (req, res) => {
  try {
    const stats = await readCourierStats();
    const courierIndex = stats.findIndex(s => s.courierId === req.params.courierId);
    const { earnings, rating } = req.body;
    
    if (courierIndex === -1) {
      // Create new courier stats
      const newStat = {
        courierId: req.params.courierId,
        deliveries: 1,
        earnings: earnings || 0,
        rating: rating || 0,
        totalRatings: rating ? 1 : 0
      };
      stats.push(newStat);
    } else {
      // Update existing courier stats
      stats[courierIndex].deliveries += 1;
      stats[courierIndex].earnings += earnings || 0;
      
      if (rating) {
        const currentTotal = stats[courierIndex].rating * stats[courierIndex].totalRatings;
        stats[courierIndex].totalRatings += 1;
        stats[courierIndex].rating = (currentTotal + rating) / stats[courierIndex].totalRatings;
      }
    }
    
    await writeCourierStats(stats);
    
    const updatedStat = stats.find(s => s.courierId === req.params.courierId);
    res.json(updatedStat);
  } catch (error) {
    console.error('Error updating courier stats:', error);
    res.status(500).json({ error: 'Failed to update courier stats' });
  }
});

// Reset courier stats (for testing)
router.delete('/:courierId', async (req, res) => {
  try {
    const stats = await readCourierStats();
    const filteredStats = stats.filter(s => s.courierId !== req.params.courierId);
    await writeCourierStats(filteredStats);
    res.json({ message: 'Courier stats reset successfully' });
  } catch (error) {
    console.error('Error resetting courier stats:', error);
    res.status(500).json({ error: 'Failed to reset courier stats' });
  }
});

export default router;